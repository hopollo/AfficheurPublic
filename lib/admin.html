<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Afficheur: Admin</title>
  <style>
    div, ul {
      border: dotted 3px grey;
      background: black;
      color: white;
      font-weight: bold;
    }
    div > * { display: block; }
    h3 { color: red; }
    ul div {
      display: flex;
    }
    ul input {
      width: 80px;
    }
    
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
    }

    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      font-size: 17px;
    }

    .tab button:hover {
      background-color: #ddd;
    }

    .tab button.active {
      background-color: #ccc;
    }

    .tabcontent {
      display: none;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-top: none;
    }
  </style>
</head>
<body>
  <div>
    <h1>Admin Panel :</h1>
    Identifiant : <input id='idInput' type="text">
    Mot de passe : <input id='passInput' type="password">

    <button id='sendButton' type="submit" disabled>Valider</button>
  </div>
  <h3 id="fetchResult"></h3>
  <script>
    const idInput = document.getElementById('idInput');
    const passInput = document.getElementById('passInput');
    const sendButton = document.getElementById('sendButton');
    const result = document.getElementById('fetchResult');
    
    passInput.addEventListener("input", () => {
      // TODO : HoPollo Tweak feature to disable back button if pass under limit
      if (passInput.value.length >= 4
          && idInput.value.length >= 3) sendButton.removeAttribute('disabled');
    });

    sendButton.onclick = () => {
      fetch('admin/menu', {
        headers : {
          authorization: `${idInput.value}|${passInput.value}`
        }
      })
      .then(res => res.text())
      .then(data => {
        if (!data.includes('[')) return result.innerHTML = data;
      })
      .catch(err => console.error(err))
    };

    function openTab(evt, tabName) {
      let i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
      
      switch(tabName) {
        case 'Users'   : GetUsers();    break;
        case 'Views'   : GetViews();    break;
        case 'Logs'    : GetLogs();     break;
        case 'Terminal': GetTerminal(); break;
        default: return;
      }
    }

    function GetUsers() {
      fetch('admin/users')
        .then(res => res.json())
        .then(users => {
          const usersTabContainer = document.createElement('table');
          const tabRows = document.createElement('tr');
          const nameTitle = document.createElement('th');
          nameTitle.appendChild(document.createTextNode('Id'));
          const accessTitle = document.createElement('th');
          accessTitle.appendChild(document.createTextNode('Access'));
          const actionsTitle = document.createElement('th');
          actionsTitle.appendChild(document.createTextNode('Actions'));

          tabRows.appendChild(nameTitle);
          tabRows.appendChild(accessTitle);
          tabRows.appendChild(actionsTitle);

          usersTabContainer.appendChild(tabRows);
          
          for (const user of users) {
            const userElement = document.createElement('tr');
            
            const userId = document.createElement('td');
            userId.appendChild(document.createTextNode(user.name));
            const userAccess = document.createElement('td');
            userAccess.appendChild(document.createTextNode(user.access));
            const userActions = document.createElement('td');
            
            userElement.appendChild(userId);
            userElement.appendChild(userAccess);
            
            usersTabContainer.appendChild(userElement);
            document.getElementById('Users').appendChild(usersTabContainer);
          }
        })
        .catch(err => console.error(err))
    }

    function createFetch() {
      const userToCreate = {
        name: createUserNameInput.value,
        pass: createUserPassInput.value,
        access: createUserAccessInput.value
      }

      fetch('admin/user', {
        method: 'POST',
        headers : {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userToCreate)
      })
      .then(res => res.text())
      .then(data => result.innerHTML = data)
      .catch(err => console.error(err));
    }

    function deleteFetch(element) {
      console.log(element.parentElement);
      const userToRemove = {
        name: element.parentElement.childNodes[0].data,
        access: element.parentElement.childNodes[1].data
      }
      
      fetch('admin/user', { 
        method: 'DELETE',
        headers : {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userToRemove)
      })
      .then(res => res.text())
      .then(data => {
        result.innerHTML = data;
      })
      .catch(err => console.error(err))
    }

    function GetViews() {
      fetch('admin/views')
        .then(res => res.json())
        .then(views => {
          const viewsTabContainer = document.createElement('table');
          const tabRows = document.createElement('tr');
          const nameTitle = document.createElement('th');
          nameTitle.appendChild(document.createTextNode('Name'));
          const sizeTitle = document.createElement('th');
          sizeTitle.appendChild(document.createTextNode('Size'));
          const dateTitle = document.createElement('th');
          dateTitle.appendChild(document.createTextNode('Date'));
          const actionsTitle = document.createElement('th');
          actionsTitle.appendChild(document.createTextNode('Actions'));

          tabRows.appendChild(nameTitle);
          tabRows.appendChild(dateTitle);
          tabRows.appendChild(sizeTitle);
          tabRows.appendChild(actionsTitle);

          viewsTabContainer.appendChild(tabRows);

          for (const view of views) {
            const viewElement = document.createElement('tr');
            
            const viewTitle = document.createElement('td');
            viewTitle.appendChild(document.createTextNode(view.title));
            const viewSize = document.createElement('td');
            viewSize.appendChild(document.createTextNode(view.size));
            const viewDate = document.createElement('td');
            viewDate.appendChild(document.createTextNode(view.date));
            const viewActions = document.createElement('td');
            
            viewElement.appendChild(viewTitle);
            viewElement.appendChild(viewDate);
            viewElement.appendChild(viewSize); 
            viewElement.appendChild(viewActions);
            
            viewsTabContainer.appendChild(viewElement);
            document.getElementById('Views').appendChild(viewsTabContainer);
          }
        })
        .catch(err => console.error(err)); 
    }

    function GetLogs() {
      fetch('admin/logs')
        .then(res => res.json())
        .then(logs => {
          const logsTabContainer = document.createElement('table');
          const tabRows = document.createElement('tr');
          const logTitle = document.createElement('th');
          logTitle.appendChild(document.createTextNode('Name'));
          const sizeTitle = document.createElement('th');
          sizeTitle.appendChild(document.createTextNode('Size'));
          const dateTitle = document.createElement('th');
          dateTitle.appendChild(document.createTextNode('Date'));
          const actionsTitle = document.createElement('th');
          actionsTitle.appendChild(document.createTextNode('Actions'));

          tabRows.appendChild(logTitle);
          tabRows.appendChild(dateTitle);
          tabRows.appendChild(sizeTitle);
          tabRows.appendChild(actionsTitle);

          logsTabContainer.appendChild(tabRows);

          for (const log of logs) {
            const logElement = document.createElement('tr');
            
            const logTitle = document.createElement('td');
            logTitle.appendChild(document.createTextNode(log.title));
            const logSize = document.createElement('td');
            logSize.appendChild(document.createTextNode(log.size));
            const logDate = document.createElement('td');
            logDate.appendChild(document.createTextNode(log.date));
            const logActions = document.createElement('td');
            
            logElement.appendChild(logTitle);
            logElement.appendChild(logDate);
            logElement.appendChild(logSize); 
            logElement.appendChild(logActions);
            
            logsTabContainer.appendChild(logElement);
            document.getElementById('Views').appendChild(logsTabContainer);
          }
        })
        .catch(err => console.error(err));
    }

    function GetTerminal() {
      fetch('admin/terminal')
        .then(res => res.json())
        .then(terminal => document.getElementById('Terminal').innerHTML = terminal)
        .catch(err => console.error(err))
    }

    document.addEventListener('click', (e) => {
      if(e.target && !e.target.className.includes('Button')) return;
      switch(e.target.className) {
        case 'delButton':
            deleteFetch(e.target);
          break;
        case 'editButton':
            editFetch(e.target);
          break;
        case 'createUserButton':
            createFetch();
        default:
      }
    });
  </script>
</body>
</html>